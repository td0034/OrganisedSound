<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ app_title }} — Session</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>Clip Ratings</h1>
      <div class="status">
        <span id="tokenBadge" class="badge">Token: {{ token }}</span>
        <span id="progressBadge" class="badge">Progress: —</span>
      </div>
    </header>

    <main class="main">
      <div id="message" class="message"></div>

      <div class="card" id="consentCard" style="display:none;">
        <div class="card-header">
          <h2>Before you begin</h2>
          <p class="prompt">Please read the study information and provide consent to continue.</p>
        </div>
        <div class="card-body">
          <div class="field">
            <label>Study information (summary)</label>
            <div class="help">
              You will watch and rate a set of short audiovisual clips generated with an experimental instrument.
              Some clips were composed under different access conditions (audio-only, visual-only, or audiovisual).
              Clips show the LED panel output with the instrument audio; no participants are shown.
            </div>
            <div class="help" style="margin-top:8px;">
              Expect approximately <span id="clipCount">—</span> clips, each around 1–2 minutes. Please allow about 1–2 hours to complete all ratings.
            </div>
            <div class="help" style="margin-top:8px;">
              Participation is voluntary. You can stop at any time. If you wish to withdraw your ratings, contact the researcher within 5 days.
            </div>
            <div class="help" style="margin-top:8px;">
              Researcher: t.didiotcook@gmail.com. Independent contact: research-governance@bristol.ac.uk.
            </div>
          </div>
          <div class="field">
            <label>Example questions (per clip)</label>
            <div class="help">You will rate items such as:</div>
            <ul class="help" style="margin:6px 0 0 18px;">
              <li>Preference, coherence/legibility, novelty/interest</li>
              <li>Fusion/equality, constructive vs destructive interference, overload</li>
              <li>Perceived human steering, inferred structure/process</li>
              <li>Attention dominance (sound vs light) and a condition guess</li>
            </ul>
          </div>
          <div class="field">
            <label>Consent</label>
            <label class="choice">
              <input id="consentCheck" type="checkbox" />
              <span>I am aged 18+ and agree to take part in this rating task.</span>
            </label>
          </div>
          <button id="consentBtn" class="btn primary" type="button" disabled>Agree and start</button>
        </div>
      </div>

      <div class="card" id="ratingCard">
        <div class="card-header">
          <h2 id="clipTitle">Loading…</h2>
          <p class="prompt" id="clipPrompt">
            Watch the clip to the end to unlock the rating form. You may replay freely.
          </p>
        </div>

        <div class="card-body">
          <div class="field">
            <label>Clip</label>
            <div class="help" id="clipMeta">—</div>
            <video id="video" controls preload="metadata"
                   style="width:100%; border-radius:12px; border:1px solid var(--line); background:#000">
            </video>
            <div class="help">Ratings appear only after you reach the end at least once.</div>
          </div>

          <form id="ratingForm" style="display:none"></form>

          <div class="row">
            <button id="saveNextBtn" class="btn primary" type="button" disabled>Save rating & Next</button>
            <button id="saveOnlyBtn" class="btn" type="button" disabled>Save only</button>
            <button id="prevBtn" class="btn subtle" type="button">Previous clip</button>
          </div>
        </div>

        <div class="card-footer">
          <a class="btn subtle" href="/" style="text-decoration:none; text-align:center;">Back to home</a>
          <a class="btn subtle" href="/api/export/ratings.csv" target="_blank" style="text-decoration:none; text-align:center;">Export ratings CSV</a>
        </div>
      </div>

      <div class="card" id="endCard" style="display:none;">
        <div class="card-header">
          <h2>End (optional)</h2>
          <p class="prompt">After rating all clips, you may provide final notes.</p>
        </div>
        <div class="card-body">
          <form id="endForm"></form>
          <button id="endSaveBtn" class="btn primary" type="button">Save end notes</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    window.__TOKEN__ = "{{ token }}";
    window.__CLIP_ID__ = {{ clip_id if clip_id is defined else "null" }};
  </script>
  <script src="/static/session.js"></script>
</body>
</html>
